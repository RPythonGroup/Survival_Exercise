---
title: "Survival Analysis with the deidentified Thyroid Cancer Dataset"
description: "ìµëª…í™”ëœ ìë£Œë¡œ ì—°ìŠµí•˜ê¸°"
author: "RPythonStudyGroup feat. ChatGPT"
date: "2025-02-03"
date-modified: "2025-02-03"
categories:
  - R
  - Survival
  - hands-on
---

### git clone

-   ì›ê²©ì €ì¥ì†Œ HTTP url: https://github.com/RPythonGroup/Survival_Exercise.git
-   í„°ë¯¸ë„ì—ì„œ git clone ì‹œ í˜„ì¬ ë””ë ‰í† ë¦¬ í•˜ë¶€ì— ì§€ì •í•˜ëŠ” ë””ë ‰í† ë¦¬ëª…ìœ¼ë¡œ clone ë¨.

``` bash
git clone https://github.com/RPythonGroup/Survival_Exercise.git R441-Survival_Exercise
```

-   RStudio í”„ë¡œì íŠ¸ë§Œë“¤ê¸°ì—ì„œ ê¸°ì¡´ ë””ë ‰í† ë¦¬ì—ì„œ ë§Œë“¤ê¸°ì—ì„œ clone ëœ ë””ë ‰í† ë¦¬ë¥¼ ì„ íƒí•˜ë©´ ë¨.
-   íŒ¨í‚¤ì§€ê´€ë¦¬ë¥¼ renvë¡œ í• ë ¤ë©´, 
    -       renv::activateë¡œ í™œì„±í™”ì‹œí‚¤ê³ ,
    -       renv::snapshot ìœ¼ë¡œ renv.lock íŒŒì¼ì˜ íŒ¨í‚¤ì§€ ëª©ë¡ì„ ì„¤ì¹˜í•˜ë„ë¡ ì˜µì…˜ì„ ì„ íƒí•˜ì‹œë©´ ë¨. 
    -       ì„¤ì¹˜ê°€ ì™„ë£Œë˜ë©´ renv::status() ë¡œ í”„ë¡œì íŠ¸ì— ì„¤ì¹˜ëœ íŒ¨í‚¤ì§€ì™€ renv.lock íŒŒì¼ì— ê¸°ë¡ëœ íŒ¨í‚¤ì§€ ëª©ë¡ì´ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸í•˜ë©´ ë¨.

### readRDS

-   Rì—ì„œë§Œ ì‚¬ìš©í•˜ëŠ” ìë£Œí˜•íƒœì¸ RDSë¥¼ ì½ì–´ì˜¤ë©°, ìë£Œí˜•ì´ ë³´ì „ë˜ê³  ë¹ ë¦„

```{r rai_recur}

library(dplyr)

rai_recur <- readRDS("deidentified_data/rai_recur.rds")
```

### mytable

-   mytableë¡œ ìë£Œ ê°œìš” íŒŒì•…
-   mylatex ì¶œë ¥ì€ ì„±ê³µí•˜ì§€ ëª»í•¨.

```{r mytable}

library(moonBook)

# mytable(recur~.,data=rai_recur) %>% mylatex() %>% cat # ì •ìƒì‘ë™ì´ ë˜ì§€ ì•ŠëŠ” ì´ìœ ëŠ”?

mytable(recur~.,data=rai_recur)
```

### Surví•¨ìˆ˜

-   timeê³¼ eventë¥¼ ì¸ìë¡œ ë°›ì•„ íŠ¹ìˆ˜í•œ í˜•íƒœì˜ matrixì¸ ìƒì¡´(survival) ê°ì²´ ë°˜í™˜

```{r Surv}

library(survival)

rai_recur$recur <- as.integer(rai_recur$recur)
km <- Surv(rai_recur$time, event = rai_recur$recur) ## default type : "right"
# km <- Surv(time=time, event = recur, data=rai_recur) # data= í˜•ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŒ

str(km)
```

```{r head}

head(km)
```

### plot

-   plot() í•¨ìˆ˜ëŠ” ì œë„¤ë¦­ í•¨ìˆ˜ë¡œ, ê¸°ë³¸ì ìœ¼ë¡œ ì‚°ì ë„ë¥¼ ê·¸ë¦¬ì§€ë§Œ, Surv ê°ì²´ë¥¼ ì¸ìë¡œ ë°›ìœ¼ë©´ ë‚´ë¶€ì ìœ¼ë¡œ plot.survfit() methodë¥¼ í˜¸ì¶œí•˜ì—¬ Kaplan-Meier(KM) ê³¡ì„ ì„ ë°˜í™˜í•¨
-   timeì˜ ë‹¨ìœ„ê°€ ì›”ì´ë¼ì„œ x ì¶•ì€ 400ê¹Œì§€ í‘œì‹œë¨

```{r plot.survfit}

plot(km) ## km - Surv class (time, status) ê°€ì§€ê³  ìˆëŠ” ë¦¬ìŠ¤íŠ¸
```

-  Surv ê°ì²´ëŠ” **survfit í•¨ìˆ˜ì˜ ì¸ì**ë¡œ ì‚¬ìš©ë˜ë¯€ë¡œ ì¤‘ìš”

### ì¤‘ì•™ê°’ ìƒì¡´ê¸°ê°„

-   50%ì— ë„ë‹¬í•˜ì§€ ëª»í•˜ì—¬ NA ë°˜í™˜ë¨

```{r median}

median(km)  ## Surv ê°ì²´ì— ëŒ€í•œ method í•¨ìˆ˜ë“¤ì´ ìˆë‹¤.
```

### í‰ê· ìƒì¡´ê¸°ê°„

-   ë°ì´í„°ì…‹ì˜ time ë³€ìˆ˜ëŠ” ì…ë ¥ë‹¨ìœ„ê°€ ì›”ì´ë¯€ë¡œ ì¬ë°œì— ì†Œìš”ëœ í‰ê· ì´ ì•½ 69ê°œì›” ?

```{r mean}

mean(km)
```

## survfití•¨ìˆ˜ì™€ ê°ì²´

-   Surv ê°ì²´ì™€ ê³µë³€ëŸ‰ì„ formula í˜•íƒœì˜ ì¸ìë¡œ ë°›ì•„ Kaplan-Meier ë˜ëŠ” Cox ëª¨ë¸ ê¸°ë°˜ ìƒì¡´ í™•ë¥ ì„ ì €ì¥í•œ ê°ì²´ë¥¼ ë°˜í™˜

### Kaplan-Meier ê¸°ë°˜

```{r plot_survfit}

plot(survfit(km~1)) #Kaplan-Meier ê¸°ë°˜
```

### cox model ê¸°ë°˜

```{r plot_cox}

km_fit <- survfit(km~rai_recur$sex) #cox model ê¸°ë°˜

plot(km_fit)
```

### summary

```{r summary1}
summary(km_fit) 
```

### summary ê¸°ê°„ì§€ì •

```{r summary2}
summary(km_fit, c(12*1:19)) ### ì •í•´ì§„ timeì— ë§ëŠ” ìƒì¡´í…Œì´ë¸”í‘œë¥¼ ë§Œë“ ë‹¤.
```

### plot ê·¸ë˜í”„ - ë²”ë¡€ì¶”ê°€

```{r plot_cox2}
plot(km_fit, col = rainbow(2), lty=1:2)
legend("topright", legend = c("Female","Male"),
col= rainbow(2), lty=1:2)
```

### ggsurvplot - risk.table ì¶”ê°€í•˜ê¸°

```{r ggsurvplot}

library(survminer)

ggsurvplot(
  km_fit, 
  data = rai_recur,
  conf.int = T, 
  xscale = 12, ## xscale can be "d_y"
  break.x.by = 5*12,
  pval = T, 
  pval.size =4, 
  surv.median.line = "hv",
  risk.table = TRUE, ## if TRUE, risk table is displayed under graph
  legend.title="sex", 
  legend.labs=c("Female","Male"),
  palette = c("#E7B800", "#2E9FDF"),
)
```

### cox ë‹¨ë³€ëŸ‰

$$
h(t | X) = h_0(t) \exp(\beta_1 X_1 + \beta_2 X_2 + \dots + \beta_p X_p)
$$ \#### sexì— ëŒ€í•œ ë‹¨ë³€ëŸ‰

```{r univariate}

univariate_model <- coxph(km ~ sex, data = rai_recur)
summary(univariate_model)
```

#### 1ï¸âƒ£ ê²€ì • ë°©ë²•ì˜ ì°¨ì´

-   Likelihood Ratio Test: ëª¨ë¸ ì „ì²´ì˜ ì í•©ë„ë¥¼ í‰ê°€í•˜ëŠ” ê°•ë ¥í•œ ê²€ì • ë°©ë²•.
-   Wald Test: ê°œë³„ íšŒê·€ ê³„ìˆ˜ê°€ 0ê³¼ ë‹¤ë¥¸ì§€ í‰ê°€í•˜ì§€ë§Œ, ìƒ˜í”Œ í¬ê¸°ê°€ ì‘ê±°ë‚˜ ê³„ìˆ˜ê°€ ë§¤ìš° í¬ë©´ ë¶€ì •í™•í•  ìˆ˜ ìˆìŒ.
-   Score Test: ì‘ì€ ìƒ˜í”Œì—ì„œë„ ì•ˆì •ì ì¸ ê²€ì •ì´ì§€ë§Œ, ì¼ë¶€ ê°€ì •ì´ ì¶©ì¡±ë˜ì§€ ì•Šìœ¼ë©´ ê²°ê³¼ê°€ ë‹¤ë¥¼ ìˆ˜ ìˆìŒ.

#### 2ï¸âƒ£ ìƒ˜í”Œ í¬ê¸° ë° ë°ì´í„° íŠ¹ì„±

-   ìƒ˜í”Œ í¬ê¸°ê°€ ì‘ì„ ë•Œ â†’ Wald TestëŠ” ë¶ˆì•ˆì •í•  ìˆ˜ ìˆìŒ.
-   ë³€ìˆ˜ ê°„ ë‹¤ì¤‘ê³µì„ ì„± â†’ Wald Testì™€ LRT ê²°ê³¼ê°€ ë‹¤ë¥¼ ìˆ˜ ìˆìŒ.
-   ê²€ì—´ ë°ì´í„° ë¹„ìœ¨ì´ ë†’ì„ ë•Œ â†’ Score Testê°€ ë‹¤ë¥¸ ë‘ ê²€ì •ê³¼ ë‹¤ë¥¼ ìˆ˜ ìˆìŒ.

#### **ğŸ“Œ (1) Likelihood Ratio Testë§Œ ìœ ì˜ë¯¸í•˜ê³  ë‚˜ë¨¸ì§€ëŠ” ìœ ì˜ë¯¸í•˜ì§€ ì•Šë‹¤ë©´?**

-   ëª¨ë¸ì´ ì „ì²´ì ìœ¼ë¡œëŠ” ì˜ë¯¸ê°€ ìˆì§€ë§Œ, ê°œë³„ ë³€ìˆ˜ì˜ íš¨ê³¼ê°€ ê°•í•˜ì§€ ì•Šì„ ìˆ˜ ìˆìŒ.\
-   Wald Testì™€ Score Testë„ í™•ì¸í•˜ë©´ì„œ **ê°œë³„ ë³€ìˆ˜ì˜ ê¸°ì—¬ë„ë¥¼ ë¶„ì„**í•´ì•¼ í•¨.

#### **ğŸ“Œ (2) Wald Testë§Œ ìœ ì˜ë¯¸í•˜ë‹¤ë©´?**

-   íŠ¹ì • ë³€ìˆ˜ì˜ íš¨ê³¼ëŠ” ê°•í•˜ì§€ë§Œ, ëª¨ë¸ ì „ì²´ê°€ ë°ì´í„°ë¥¼ ì¶©ë¶„íˆ ì„¤ëª…í•˜ì§€ ëª»í•  ìˆ˜ ìˆìŒ.\
-   ë³€ìˆ˜ ì„ íƒì„ ë‹¤ì‹œ ê²€í† í•˜ê³  ë‹¤ì¤‘ê³µì„ ì„±ì„ ì ê²€í•´ì•¼ í•¨.

#### **ğŸ“Œ (3) Score Testë§Œ ìœ ì˜ë¯¸í•˜ë‹¤ë©´?**

-   ë°ì´í„°ê°€ ì˜ ë§ì§€ë§Œ, íŠ¹ì • ë³€ìˆ˜ì˜ íš¨ê³¼ê°€ ë¶ˆí™•ì‹¤í•  ê°€ëŠ¥ì„±ì´ ìˆìŒ.\
-   ëª¨ë¸ì˜ êµ¬ì¡°ì™€ ë°ì´í„°ì˜ ë¶„í¬ë¥¼ ë‹¤ì‹œ í™•ì¸í•´ì•¼ í•¨.

### cox ë‹¨ë³€ëŸ‰ ë°˜ë³µ

```{r mycph}

mycph(Surv(time, recur) ~ sex+surgeon+Risk+pT+gross_ETE+pN+ENE, data = rai_recur)

```

### Multivariate Analysis

```{r Multivariate}

cox_model1 <- coxph(Surv(time, recur) ~ sex+surgeon+Risk+pT+gross_ETE+pN+ENE, data = rai_recur)
summary(cox_model1)
```

### Multivariate - anova

-   anova(cox_model1)ëŠ” Cox íšŒê·€ ëª¨ë¸ì—ì„œ ê° ë³€ìˆ˜ì˜ ê¸°ì—¬ë„ë¥¼ í‰ê°€í•˜ëŠ” ì—­í• ì„ í•¨.
-   ê° ë³€ìˆ˜ê°€ ëª¨ë¸ì— ì–¼ë§ˆë‚˜ ì¤‘ìš”í•œì§€ í‰ê°€í•˜ê³ , p-valueë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë¶ˆí•„ìš”í•œ ë³€ìˆ˜ë¥¼ ì œê±°í•  ìˆ˜ ìˆìŒ.
-   Deviance ê°’ì´ í¬ê³  p-valueê°€ ë‚®ì€ ë³€ìˆ˜ëŠ” ì¤‘ìš”í•œ ë³€ìˆ˜ì´ë©°, p-valueê°€ ë†’ìœ¼ë©´ ì œê±°ë¥¼ ê³ ë ¤í•  ìˆ˜ ìˆìŒ.

```{r anova}

anova(cox_model1)
```

-   Cox íšŒê·€ ëª¨ë¸ì—ì„œëŠ” ë¡œê·¸ ìš°ë„ë¥¼ ìµœëŒ€í™”(ì¦‰, ëœ ìŒìˆ˜ë¡œ ë§Œë“¦) í•˜ëŠ” ë°©í–¥ìœ¼ë¡œ ìµœì í™”ë¥¼ ìˆ˜í–‰
    -   NULL ëª¨ë¸ (loglik = -567.06) â†’ ë³€ìˆ˜ê°€ ì—†ëŠ” ê¸°ë³¸ ëª¨ë¸
    -   ëª¨ë¸ì´ ì ì  ì¢‹ì•„ì§ˆìˆ˜ë¡ loglik ê°’ ì¦ê°€
    -   sex ì¶”ê°€ í›„: loglik = -560.92 (ì¦ê°€)
    -   surgeon ì¶”ê°€ í›„: loglik = -540.38 (ë” ì¦ê°€)
    -   Risk ì¶”ê°€ í›„: loglik = -521.33 (ë” ì¦ê°€)

### Multivariate - refit

```{r refit1}

cox_model_refit <- coxph(Surv(time, recur) ~ sex+surgeon+Risk, data = rai_recur)
summary(cox_model_refit)
```

### survfit plot

```{r plot3}

plot(survfit(cox_model1), ylim = c(0.6,1),xlab = "months",
ylab = "Proportion not reached")
```
### time histogram

```{r time_hist}

with(rai_recur, hist(time/12, breaks = 40, main = "Histogram of time"))
```
### age histogram
```{r age_hist}

with(rai_recur, hist(age, breaks = 16, main = "Histogram of age"))
```
### size histogram
```{r size_hist}

with(rai_recur, hist(size, breaks = 16, main = "Histogram of age"))
```

### age residual
```{r age_residual}

m1 <- coxph(Surv(time,recur)~1,data = rai_recur)
rai_recur$resid <- residuals(m1, type = "martingale")
rai_recur %>% ggplot(aes(age,resid))+geom_point()+geom_smooth()+theme_classic()

```

### size residual
```{r size_residual}

rai_recur %>% ggplot(aes(size,resid))+geom_point()+geom_smooth()+theme_classic()
```

### cox ë‹¨ë³€ëŸ‰ ë°˜ë³µ2

```{r mycph_all}

mycph(Surv(time, recur) ~ age+sex+surgeon+Risk+pT+size+gross_ETE+pN+ENE, data = rai_recur)

```
### Multivariate Analysis 2

```{r Multivariate_all}

cox_model2 <- coxph(Surv(time, recur) ~ age+sex+surgeon+Risk+pT+size+gross_ETE+pN+ENE, data = rai_recur)
summary(cox_model2)
```

### Multivariate - anova 2

```{r anova2}

anova(cox_model2)
```

### Multivariate refit 2

```{r refit2}

cox_model_refit2 <- coxph(Surv(time, recur) ~ age+sex+surgeon+Risk+size+pN, data = rai_recur)
summary(cox_model_refit2)
```


```{r end}

```
